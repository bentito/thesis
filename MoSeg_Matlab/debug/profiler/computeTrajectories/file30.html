<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><link rel="stylesheet" href="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/matlab-report-styles.css" type="text/css" /><title>Function details for computeTrajectories</title><link rel="stylesheet" href="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/matlab-report-styles.css" type="text/css" /></head><body bgcolor="#F8F8F8"><strong>This is a static copy of a profile report</strong><p><a href="file0.html">Home</a><p><span style="font-size:14pt; background:#FFE4B0">computeTrajectories (1 call, 1788.226 sec)</span><br/><i>Generated 11-May-2013 11:20:16 using cpu time.</i><br/>function in file /home/rlange/thesis/workspace/MoSeg_Matlab/computeTrajectories.m<br/>Copy to new window for comparing multiple runs<div class="grayline"/><div class="grayline"/><strong>Parents</strong> (calling functions)<br/> No parent <div class="grayline"/><strong>Lines where the most time was spent</strong><br/> <p><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Line Number</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Code</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Calls</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Total Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">% Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Time Plot</td></tr><tr><td class="td-linebottomrt"><a href="#Line126">126</a></td><td class="td-linebottomrt"><pre>new_trajectories = initializeT...</pre></td><td class="td-linebottomrt">29</td><td class="td-linebottomrt">469.450 s</td><td class="td-linebottomrt" class="td-linebottomrt">26.3%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=26 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line85">85</a></td><td class="td-linebottomrt"><pre>bdy = interp2(bv, pt_new(2), p...</pre></td><td class="td-linebottomrt">26526</td><td class="td-linebottomrt">167.088 s</td><td class="td-linebottomrt" class="td-linebottomrt">9.3%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=9 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line74">74</a></td><td class="td-linebottomrt"><pre>dy = interp2(v, point(2), poin...</pre></td><td class="td-linebottomrt">26526</td><td class="td-linebottomrt">166.177 s</td><td class="td-linebottomrt" class="td-linebottomrt">9.3%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=9 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line73">73</a></td><td class="td-linebottomrt"><pre>dx = interp2(u, point(2), poin...</pre></td><td class="td-linebottomrt">26526</td><td class="td-linebottomrt">163.444 s</td><td class="td-linebottomrt" class="td-linebottomrt">9.1%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=9 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line91">91</a></td><td class="td-linebottomrt"><pre>gux = interp2(grad_u_x, point(...</pre></td><td class="td-linebottomrt">25294</td><td class="td-linebottomrt">162.715 s</td><td class="td-linebottomrt" class="td-linebottomrt">9.1%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=9 height=10></td></tr><tr><td class="td-linebottomrt">All other lines</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">659.351 s</td><td class="td-linebottomrt">36.9%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=37 height=10></td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Totals</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">1788.226 s</td><td class="td-linebottomrt" bgcolor="#F0F0F0">100%</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td></tr></table><div class="grayline"/><b>Children</b> (called functions)<br/><p><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Function Name</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Function Type</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Calls</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Total Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">% Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Time Plot</td></tr><tr><td class="td-linebottomrt"><a href="file40.html">interp2</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">207280</td><td class="td-linebottomrt">1282.734 s</td><td class="td-linebottomrt">71.7%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=72 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file42.html">initializeTrajectories</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">30</td><td class="td-linebottomrt">470.143 s</td><td class="td-linebottomrt">26.3%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=26 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file50.html">parallel_function</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">21.282 s</td><td class="td-linebottomrt">1.2%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=1 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file97.html">computeTrajectories>@(pts)pts(:,end)</a></td><td class="td-linebottomrt">anonymous function</td><td class="td-linebottomrt">24263</td><td class="td-linebottomrt">0.911 s</td><td class="td-linebottomrt">0.1%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file29.html">verifyMosegParams</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0.838 s</td><td class="td-linebottomrt">0.0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file28.html">...r.VideoReader>VideoReader.VideoReader</a></td><td class="td-linebottomrt">subfunction</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0.729 s</td><td class="td-linebottomrt">0.0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file43.html">DGradient</a></td><td class="td-linebottomrt">MEX-file</td><td class="td-linebottomrt">116</td><td class="td-linebottomrt">0.073 s</td><td class="td-linebottomrt">0.0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file49.html">parfor_endpoint_check</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">2</td><td class="td-linebottomrt">0.036 s</td><td class="td-linebottomrt">0.0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file33.html">VideoReader.read</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">2</td><td class="td-linebottomrt">0.036 s</td><td class="td-linebottomrt">0.0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file32.html">...Reader.VideoReader>VideoReader.delete</a></td><td class="td-linebottomrt">subfunction</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file96.html">...teTrajectories>create@(pts)pts(:,end)</a></td><td class="td-linebottomrt">anonymous function</td><td class="td-linebottomrt">29</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file88.html">progress</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">29</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file48.html">parfor_sliced_fcnhdl_check</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file38.html">get_para_flow</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file37.html">...er.VideoReader>VideoReader.get.Height</a></td><td class="td-linebottomrt">subfunction</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file36.html">...der.VideoReader>VideoReader.get.Width</a></td><td class="td-linebottomrt">subfunction</td><td class="td-linebottomrt">1</td><td class="td-linebottomrt">0 s</td><td class="td-linebottomrt">0%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt">Self time (built-ins, overhead, etc.)</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">11.443 s</td><td class="td-linebottomrt">0.6%</td><td class="td-linebottomrt"><img src="file:////usr/local/matlab_v7.11/toolbox/matlab/codetools/private/one-pixel.gif" width=1 height=10></td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Totals</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">1788.226 s</td><td class="td-linebottomrt" bgcolor="#F0F0F0">100%</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td></tr></table><div class="grayline"/><strong>Code Analyzer results</strong><br/><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Line number</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Message</td></tr><tr><td class="td-linebottomrt"><a href="#Line131">131</a></td><td class="td-linebottomrt"><span class="mono">The variable 'traj_array' appears to change size on every loop iteration. Consider preallocating for speed.</span></td></tr></table><div class="grayline"/><strong>Coverage results</strong><br/>[ Show coverage for parent directory ]<br/><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Total lines in function</td><td class="td-linebottomrt">136</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Non-code lines (comments, blank lines)</td><td class="td-linebottomrt">57</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Code lines (lines that can run)</td><td class="td-linebottomrt">79</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Code lines that did run</td><td class="td-linebottomrt">70</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Code lines that did not run</td><td class="td-linebottomrt">9</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Coverage (did run/can run)</td><td class="td-linebottomrt">88.61 %</td></tr></table><div class="grayline"/><b>Function listing</b><br/><pre> <span style="color: #FF0000; font-weight: bold; text-decoration: none">  time</span> <span style="color: #0000FF; font-weight: bold; text-decoration: none">  calls</span>  <span style="font-weight: bold; text-decoration: none">line</span><br/>               <span style="color: #A0A0A0">  10</span> <span style="color: #A0A0A0; background: #FFFFFF;">function [traj_array, forward_flows, backward_flows] = ...</span><br/>               <span style="color: #A0A0A0">  11</span> <span style="color: #A0A0A0; background: #FFFFFF;">    computeTrajectories(mosegParams)</span><br/>               <span style="color: #A0A0A0">  12</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/><span style="color: #FF0000">  0.84 </span><span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  13</span> <span style="color: #000000; background: #FFFFFF;"><a href="file29.html">verifyMosegParams</a>(mosegParams, 'computeTrajectories.m'); </span><br/>               <span style="color: #A0A0A0">  14</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/><span style="color: #FF0000">  0.73 </span><span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  15</span> <span style="color: #000000; background: #FFFFFF;">V = VideoReader(mosegParams.video_file); </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  16</span> <span style="color: #000000; background: #FFFFFF;">Vdata = get(V, {'Width', 'Height'}); </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  17</span> <span style="color: #000000; background: #FFFFFF;">width = Vdata{1}; </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  18</span> <span style="color: #000000; background: #FFFFFF;">height = Vdata{2}; </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  19</span> <span style="color: #000000; background: #FFFFFF;">ldof_params = <a href="file38.html">get_para_flow</a>(height, width); </span><br/>               <span style="color: #A0A0A0">  20</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/><span style="color: #FF0000">  0.73 </span><span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  21</span> <span style="color: #000000; background: #FFFFFF;">traj_array = <a href="file42.html">initializeTrajectories</a>(read(V, mosegParams.startframe), mosegParams); </span><br/>               <span style="color: #A0A0A0">  22</span> <span style="color: #228B22; background: #FFFFFF;">% trajectories before this index are 'closed.' that is, they have been</span><br/>               <span style="color: #A0A0A0">  23</span> <span style="color: #228B22; background: #FFFFFF;">% fully computed from start frame to end frame.</span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  24</span> <span style="color: #000000; background: #FFFFFF;">open_index = 1; </span><br/>               <span style="color: #A0A0A0">  25</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/>               <span style="color: #A0A0A0">  26</span> <span style="color: #228B22; background: #FFFFFF;">% precompute optic flow since this is a big time bottleneck and can be more</span><br/>               <span style="color: #A0A0A0">  27</span> <span style="color: #228B22; background: #FFFFFF;">% easily parallelized if done as a separate step</span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  28</span> <span style="color: #000000; background: #FFFFFF;">frames = mosegParams.startframe : mosegParams.endframe-1; </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  29</span> <span style="color: #000000; background: #FFFFFF;">forward_flows = cell(1, length(frames)); </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  30</span> <span style="color: #000000; background: #FFFFFF;">backward_flows = cell(1, length(frames)); </span><br/><span style="color: #FF0000"> 21.32 </span><span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  31</span> <span style="color: #000000; background: #FFFFFF;">parfor i=1:length(frames) </span><br/>               <span style="color: #A0A0A0">  32</span> <span style="color: #A0A0A0; background: #FFFFFF;">    f = frames(i);</span><br/>               <span style="color: #A0A0A0">  33</span> <span style="color: #A0A0A0; background: #FFFFFF;">    Icurr = read(V, f);</span><br/>               <span style="color: #A0A0A0">  34</span> <span style="color: #A0A0A0; background: #FFFFFF;">    Inext = read(V, f+1);</span><br/>               <span style="color: #A0A0A0">  35</span> <span style="color: #A0A0A0; background: #FFFFFF;">    fprintf('forward flow %d\n', i);</span><br/>               <span style="color: #A0A0A0">  36</span> <span style="color: #A0A0A0; background: #FFFFFF;">    [flow, ~, ~] = LDOF(Icurr, Inext, ldof_params, false);</span><br/>               <span style="color: #A0A0A0">  37</span> <span style="color: #A0A0A0; background: #FFFFFF;">    forward_flows{i} = flow;</span><br/>               <span style="color: #A0A0A0">  38</span> <span style="color: #A0A0A0; background: #FFFFFF;">    fprintf('backward flow %d\n', i);</span><br/>               <span style="color: #A0A0A0">  39</span> <span style="color: #A0A0A0; background: #FFFFFF;">    [back_flow, ~, ~] = LDOF(Inext, Icurr, ldof_params, false);</span><br/>               <span style="color: #A0A0A0">  40</span> <span style="color: #A0A0A0; background: #FFFFFF;">    backward_flows{i} = back_flow;</span><br/>               <span style="color: #A0A0A0">  41</span> <span style="color: #A0A0A0; background: #FFFFFF;">end</span><br/>               <span style="color: #A0A0A0">  42</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/>               <span style="color: #A0A0A0">  43</span> <span style="color: #228B22; background: #FFFFFF;">% main loop to build trajectories</span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  44</span> <span style="color: #000000; background: #FFFFFF;">Inext = read(V, mosegParams.startframe); </span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold">  45</span> <span style="color: #000000; background: #FFFFFF;">for i=1:length(frames) </span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  46</span> <span style="color: #000000; background: #FFFFFF;">    f = frames(i); </span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  47</span> <span style="color: #000000; background: #FFFFFF;">    <a href="file88.html">progress</a>('trajectories: frame ', f, mosegParams.endframe-1); </span><br/>               <span style="color: #A0A0A0">  48</span> <span style="color: #228B22; background: #FFFFFF;">    % get forward flow from frame f to frame f+1</span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  49</span> <span style="color: #000000; background: #FFFFFF;">    flow = forward_flows{i}; </span><br/><span style="color: #FF0000">  0.07 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  50</span> <span style="color: #000000; background: #FFFFFF;">    u = flow(:,:,1); % u is flow in x direction </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  51</span> <span style="color: #000000; background: #FFFFFF;">    v = flow(:,:,2); % v is flow in y direction </span><br/>               <span style="color: #A0A0A0">  52</span> <span style="color: #228B22; background: #FFFFFF;">    % gradient of flow is used for checking motion boundaries</span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  53</span> <span style="color: #000000; background: #FFFFFF;">    grad_u_x = <a href="file43.html">DGradient</a>(u); </span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  54</span> <span style="color: #000000; background: #FFFFFF;">    grad_u_y = <a href="file43.html">DGradient</a>(u,2); </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  55</span> <span style="color: #000000; background: #FFFFFF;">    grad_v_x = <a href="file43.html">DGradient</a>(v); </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  56</span> <span style="color: #000000; background: #FFFFFF;">    grad_v_y = <a href="file43.html">DGradient</a>(v,2); </span><br/>               <span style="color: #A0A0A0">  57</span> <span style="color: #228B22; background: #FFFFFF;">    % get backward flow from frame f+1 back to frame f. This is used to</span><br/>               <span style="color: #A0A0A0">  58</span> <span style="color: #228B22; background: #FFFFFF;">    % check for occlusions. in the no-occlusion case, the fwd and backward</span><br/>               <span style="color: #A0A0A0">  59</span> <span style="color: #228B22; background: #FFFFFF;">    % flows will agree (since they came from the same object)</span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  60</span> <span style="color: #000000; background: #FFFFFF;">    back_flow = backward_flows{i}; </span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  61</span> <span style="color: #000000; background: #FFFFFF;">    bu = back_flow(:,:,1); </span><br/><span style="color: #FF0000">  0.07 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  62</span> <span style="color: #000000; background: #FFFFFF;">    bv = back_flow(:,:,2); </span><br/>               <span style="color: #A0A0A0">  63</span> <span style="color: #228B22; background: #FFFFFF;">    % loop over open trajectories. either extend them with new points or</span><br/>               <span style="color: #A0A0A0">  64</span> <span style="color: #228B22; background: #FFFFFF;">    % close them.</span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold">  65</span> <span style="color: #000000; background: #FFFFFF;">    for t = open_index:length(traj_array) </span><br/>               <span style="color: #A0A0A0">  66</span> <span style="color: #228B22; background: #FFFFFF;">        % follow the optic flow vector to follow this point to the next</span><br/>               <span style="color: #A0A0A0">  67</span> <span style="color: #228B22; background: #FFFFFF;">        % frame</span><br/><span style="color: #FF0000">  1.17 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  68</span> <span style="color: #000000; background: #FFFFFF;">        point = traj_array(t).points(:,end); </span><br/>               <span style="color: #A0A0A0">  69</span> <span style="color: #228B22; background: #FFFFFF;">        % interp2 is used to interpolate the flow at non-integer pixels.</span><br/>               <span style="color: #A0A0A0">  70</span> <span style="color: #228B22; background: #FFFFFF;">        % The default (and desired) method is bilinear interpolation.</span><br/>               <span style="color: #A0A0A0">  71</span> <span style="color: #228B22; background: #FFFFFF;">        % note that interp2 takes (x,y) but point is [row; col], so they</span><br/>               <span style="color: #A0A0A0">  72</span> <span style="color: #228B22; background: #FFFFFF;">        % appear to be reversed</span><br/><span style="color: #FF0000"> 163.44 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  73</span> <a name="Line73"></a><span style="color: #000000; background: #FFD4D4;">        dx = <a href="file40.html">interp2</a>(u, point(2), point(1)); </span><br/><span style="color: #FF0000"> 166.18 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  74</span> <a name="Line74"></a><span style="color: #000000; background: #FFD4D4;">        dy = <a href="file40.html">interp2</a>(v, point(2), point(1)); </span><br/><span style="color: #FF0000">  0.80 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  75</span> <span style="color: #000000; background: #FFFFFF;">        pt_new = point + [dy dx]'; </span><br/>               <span style="color: #A0A0A0">  76</span> <span style="color: #228B22; background: #FFFFFF;">        % two conditions can cause us to stop tracking this point:</span><br/>               <span style="color: #A0A0A0">  77</span> <span style="color: #228B22; background: #FFFFFF;">        % 1) the point is occluded by some other object. this is measured</span><br/>               <span style="color: #A0A0A0">  78</span> <span style="color: #228B22; background: #FFFFFF;">        %    by checking the consistency between forward and backward flow.</span><br/>               <span style="color: #A0A0A0">  79</span> <span style="color: #228B22; background: #FFFFFF;">        % 2) the point is on an ambiguous motion boundary that could cause</span><br/>               <span style="color: #A0A0A0">  80</span> <span style="color: #228B22; background: #FFFFFF;">        %    it to switch objects later</span><br/>               <span style="color: #A0A0A0">  81</span> <span style="color: #228B22; background: #FFFFFF;">        % # Occlusion Check</span><br/>               <span style="color: #A0A0A0">  82</span> <span style="color: #228B22; background: #FFFFFF;">        % this is done as a consistestency check between forward and</span><br/>               <span style="color: #A0A0A0">  83</span> <span style="color: #228B22; background: #FFFFFF;">        % backward flow.</span><br/><span style="color: #FF0000"> 160.13 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  84</span> <span style="color: #000000; background: #FFD4D4;">        bdx = <a href="file40.html">interp2</a>(bu, pt_new(2), pt_new(1)); </span><br/><span style="color: #FF0000"> 167.09 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  85</span> <a name="Line85"></a><span style="color: #000000; background: #FFD4D4;">        bdy = <a href="file40.html">interp2</a>(bv, pt_new(2), pt_new(1)); </span><br/>               <span style="color: #A0A0A0">  86</span> <span style="color: #228B22; background: #FFFFFF;">        % see equation (5) from Sundaram 2010</span><br/><span style="color: #FF0000">  0.15 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  87</span> <span style="color: #000000; background: #FFFFFF;">        consistent = (dx+bdx)^2 + (dy+bdy)^2 &lt; ... </span><br/>               <span style="color: #A0A0A0">  88</span> <span style="color: #000000; background: #FFFFFF;">            0.01*(dx^2 + dy^2 + bdx^2 + bdy^2) + 0.5;</span><br/><span style="color: #FF0000">  0.15 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  89</span> <span style="color: #000000; background: #FFFFFF;">        stop_tracking = false; </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold">  90</span> <span style="color: #000000; background: #FFFFFF;">        if consistent </span><br/><span style="color: #FF0000"> 162.72 </span><span style="color: #0000FF">  25294 </span><span style="color: #000000; font-weight: bold">  91</span> <a name="Line91"></a><span style="color: #000000; background: #FFD4D4;">            gux = <a href="file40.html">interp2</a>(grad_u_x, point(2), point(1)); </span><br/><span style="color: #FF0000"> 157.94 </span><span style="color: #0000FF">  25294 </span><span style="color: #000000; font-weight: bold">  92</span> <span style="color: #000000; background: #FFD4D4;">            guy = <a href="file40.html">interp2</a>(grad_u_y, point(2), point(1)); </span><br/><span style="color: #FF0000"> 156.45 </span><span style="color: #0000FF">  25294 </span><span style="color: #000000; font-weight: bold">  93</span> <span style="color: #000000; background: #FFD4D4;">            gvx = <a href="file40.html">interp2</a>(grad_v_x, point(2), point(1)); </span><br/><span style="color: #FF0000"> 154.37 </span><span style="color: #0000FF">  25294 </span><span style="color: #000000; font-weight: bold">  94</span> <span style="color: #000000; background: #FFD4D4;">            gvy = <a href="file40.html">interp2</a>(grad_v_y, point(2), point(1)); </span><br/>               <span style="color: #A0A0A0">  95</span> <span style="color: #228B22; background: #FFFFFF;">            % # Motion Boundary Check</span><br/>               <span style="color: #A0A0A0">  96</span> <span style="color: #228B22; background: #FFFFFF;">            % see equation (6) from Sundaram 2010.</span><br/><span style="color: #FF0000">  0.07 </span><span style="color: #0000FF">  25294 </span><span style="color: #000000; font-weight: bold">  97</span> <span style="color: #000000; background: #FFFFFF;">            motion_boundary = gux^2 + guy^2 + gvx^2 + gvy^2 &gt; ... </span><br/>               <span style="color: #A0A0A0">  98</span> <span style="color: #000000; background: #FFFFFF;">                0.01 * (dx^2 + dy^2) + 0.002;</span><br/><span style="color: #FF0000">  0.55 </span><span style="color: #0000FF">  25294 </span><span style="color: #000000; font-weight: bold">  99</span> <span style="color: #000000; background: #FFFFFF;">            if motion_boundary, stop_tracking = true; end </span><br/>       <span style="color: #0000FF">   1232 </span><span style="color: #000000; font-weight: bold"> 100</span> <span style="color: #228B22; background: #FFFFFF;">        else </span><br/>       <span style="color: #0000FF">   1232 </span><span style="color: #000000; font-weight: bold"> 101</span> <span style="color: #000000; background: #FFFFFF;">            stop_tracking = true; </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">   1232 </span><span style="color: #000000; font-weight: bold"> 102</span> <span style="color: #000000; background: #FFFFFF;">        end </span><br/><span style="color: #FF0000">  0.26 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold"> 103</span> <span style="color: #000000; background: #FFFFFF;">        if stop_tracking </span><br/>               <span style="color: #A0A0A0"> 104</span> <span style="color: #228B22; background: #FFFFFF;">            % we aren't tracking to frame f+1, so last frame is f</span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">   2263 </span><span style="color: #000000; font-weight: bold"> 105</span> <span style="color: #000000; background: #FFFFFF;">            traj_array(t).endframe = f; </span><br/>       <span style="color: #0000FF">   2263 </span><span style="color: #000000; font-weight: bold"> 106</span> <span style="color: #000000; background: #FFFFFF;">            traj_array(t).duration = (f - traj_array(t).startframe + 1); </span><br/>               <span style="color: #A0A0A0"> 107</span> <span style="color: #228B22; background: #FFFFFF;">            % transfer this trajectory to the 'closed' part of the array</span><br/>               <span style="color: #A0A0A0"> 108</span> <span style="color: #228B22; background: #FFFFFF;">            % (that is, all indices before 'open index') by swapping it</span><br/>               <span style="color: #A0A0A0"> 109</span> <span style="color: #228B22; background: #FFFFFF;">            % with the first open one.</span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">   2263 </span><span style="color: #000000; font-weight: bold"> 110</span> <span style="color: #000000; background: #FFFFFF;">            temp = traj_array(open_index); </span><br/><span style="color: #FF0000">  0.07 </span><span style="color: #0000FF">   2263 </span><span style="color: #000000; font-weight: bold"> 111</span> <span style="color: #000000; background: #FFFFFF;">            traj_array(open_index) = traj_array(t); </span><br/>       <span style="color: #0000FF">   2263 </span><span style="color: #000000; font-weight: bold"> 112</span> <span style="color: #000000; background: #FFFFFF;">            traj_array(t) = temp; </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">   2263 </span><span style="color: #000000; font-weight: bold"> 113</span> <span style="color: #000000; background: #FFFFFF;">            open_index = open_index + 1; </span><br/><span style="color: #FF0000">  0.11 </span><span style="color: #0000FF">  24263 </span><span style="color: #000000; font-weight: bold"> 114</span> <span style="color: #228B22; background: #FFFFFF;">        else </span><br/>               <span style="color: #A0A0A0"> 115</span> <span style="color: #228B22; background: #FFFFFF;">            % this trajectory is still open. add a new point to it.</span><br/><span style="color: #FF0000">  1.53 </span><span style="color: #0000FF">  24263 </span><span style="color: #000000; font-weight: bold"> 116</span> <span style="color: #000000; background: #FFFFFF;">            traj_array(t).points(:,end+1) = pt_new; </span><br/><span style="color: #FF0000">  0.11 </span><span style="color: #0000FF">  24263 </span><span style="color: #000000; font-weight: bold"> 117</span> <span style="color: #000000; background: #FFFFFF;">        end </span><br/><span style="color: #FF0000">  0.15 </span><span style="color: #0000FF">  26526 </span><span style="color: #000000; font-weight: bold"> 118</span> <span style="color: #000000; background: #FFFFFF;">    end </span><br/>               <span style="color: #A0A0A0"> 119</span> <span style="color: #228B22; background: #FFFFFF;">    </span><br/>               <span style="color: #A0A0A0"> 120</span> <span style="color: #228B22; background: #FFFFFF;">    % here, all trajectories have been updated for frame f. Some were</span><br/>               <span style="color: #A0A0A0"> 121</span> <span style="color: #228B22; background: #FFFFFF;">    % closed, so we need to re-initialize in textured areas of the image</span><br/>               <span style="color: #A0A0A0"> 122</span> <span style="color: #228B22; background: #FFFFFF;">    % just like for the first frame.</span><br/><span style="color: #FF0000">  1.13 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold"> 123</span> <span style="color: #000000; background: #FFFFFF;">    endpts_cell = cellfun(@(pts) pts(:,end), ... </span><br/>               <span style="color: #A0A0A0"> 124</span> <span style="color: #000000; background: #FFFFFF;">        {traj_array(open_index:end).points}, 'UniformOutput', false);</span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold"> 125</span> <span style="color: #000000; background: #FFFFFF;">    endpts_aray = horzcat(endpts_cell{:}); </span><br/><span style="color: #FF0000"> 469.45 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold"> 126</span> <a name="Line126"></a><span style="color: #000000; background: #FF8080;">    new_trajectories = <a href="file42.html">initializeTrajectories</a>(Inext, mosegParams, ... </span><br/>               <span style="color: #A0A0A0"> 127</span> <span style="color: #000000; background: #FF8080;">        endpts_aray);</span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold"> 128</span> <span style="color: #000000; background: #FFFFFF;">    for t2 = 1:length(new_trajectories) </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">   3229 </span><span style="color: #000000; font-weight: bold"> 129</span> <span style="color: #000000; background: #FFFFFF;">        new_trajectories(t2).startframe = f+1; </span><br/>       <span style="color: #0000FF">   3229 </span><span style="color: #000000; font-weight: bold"> 130</span> <span style="color: #000000; background: #FFFFFF;">    end </span><br/><a name="Line131"></a>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold"> 131</span> <span style="color: #000000; background: #FFFFFF;">    traj_array = horzcat(traj_array, new_trajectories); </span><br/>       <span style="color: #0000FF">     29 </span><span style="color: #000000; font-weight: bold"> 132</span> <span style="color: #000000; background: #FFFFFF;">end </span><br/>               <span style="color: #A0A0A0"> 133</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/>               <span style="color: #A0A0A0"> 134</span> <span style="color: #228B22; background: #FFFFFF;">% all remaining trajectories' end frame is the final frame</span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold"> 135</span> <span style="color: #000000; background: #FFFFFF;">for t = open_index:length(traj_array) </span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">   1194 </span><span style="color: #000000; font-weight: bold"> 136</span> <span style="color: #000000; background: #FFFFFF;">    traj_array(t).endframe = mosegParams.endframe; </span><br/>       <span style="color: #0000FF">   1194 </span><span style="color: #000000; font-weight: bold"> 137</span> <span style="color: #000000; background: #FFFFFF;">    traj_array(t).duration = ... </span><br/>               <span style="color: #A0A0A0"> 138</span> <span style="color: #000000; background: #FFFFFF;">        traj_array(t).endframe - traj_array(t).startframe + 1;</span><br/>       <span style="color: #0000FF">   1194 </span><span style="color: #000000; font-weight: bold"> 139</span> <span style="color: #000000; background: #FFFFFF;">end </span><br/>               <span style="color: #A0A0A0"> 140</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/>               <span style="color: #A0A0A0"> 141</span> <span style="color: #228B22; background: #FFFFFF;">% remove trajectories whose duration is only one frame (these give no</span><br/>               <span style="color: #A0A0A0"> 142</span> <span style="color: #228B22; background: #FFFFFF;">% information to further processing, and only get in the way)</span><br/><span style="color: #FF0000">  0.04 </span><span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold"> 143</span> <span style="color: #000000; background: #FFFFFF;">traj_array = traj_array([traj_array.duration] &gt; 1); </span><br/>               <span style="color: #A0A0A0"> 144</span> <span style="color: #228B22; background: #FFFFFF;"></span><br/>       <span style="color: #0000FF">      1 </span><span style="color: #000000; font-weight: bold"> 145</span> <span style="color: #000000; background: #FFFFFF;">end </span><br/></pre></body></html>